# 翻译校验工具 (Translation Checker)

基于大语言模型的中英文翻译质量校验桌面工具。读取 Excel 中的中英文对照文本，逐条（或批量）调用 LLM API 进行评分与问题分析，生成带颜色标注的评估报告。

---

## 目录

- [功能概览](#功能概览)
- [安装与运行](#安装与运行)
- [快速上手](#快速上手)
- [界面说明](#界面说明)
- [设置详解](#设置详解)
- [输入文件格式](#输入文件格式)
- [输出报告说明](#输出报告说明)
- [内置提示词模板](#内置提示词模板)
- [高级功能](#高级功能)
- [常见问题](#常见问题)

---

## 功能概览

- 读取 `.xlsx` Excel 文件，自动识别中文原文（A 列）和英文译文（B 列）
- 支持 OpenAI、DeepSeek、通义千问、Moonshot、智谱 GLM 及任意 OpenAI 兼容 API
- 4 种内置校验模板：准确性、术语一致性、风格流畅性、综合评估
- 支持自定义提示词模板
- 1-10 分评分，附带问题列表、修改建议和总结
- 批量模式：一次请求校验多行，减少 API 调用次数
- 429 频率限制自动重试，读取 `Retry-After` 智能等待
- 断点续传：中断后可从上次进度恢复
- 提前停止时自动导出已完成的部分结果
- 生成颜色标注的 Excel 报告（红/黄/绿）

---

## 安装与运行

### 方式一：直接下载（推荐）

前往 [Releases](../../releases) 页面下载最新的 `TranslationChecker-windows.zip`，解压后双击 `TranslationChecker.exe` 即可运行，无需安装 Python。

### 方式二：从源码运行

**环境要求：** Python 3.8+

```bash
# 克隆仓库
git clone <仓库地址>
cd translation-checker

# 安装依赖
pip install -r requirements.txt

# 运行
python main.py
```

### 依赖列表

| 包名 | 用途 |
|------|------|
| customtkinter | 现代化 GUI 框架 |
| requests | HTTP 请求（调用 LLM API） |
| openpyxl | Excel 读写 |

---

## 快速上手

1. **启动程序** — 双击 exe 或运行 `python main.py`
2. **配置 API** — 点击右上角「设置」，选择 API 服务商，填写 API Key，点击「测试连接」确认可用
3. **选择 Excel 文件** — 点击「选择文件」，选中包含中英文对照的 `.xlsx` 文件
4. **选择校验模板** — 从下拉列表选择内置模板或自定义模板
5. **选择输出目录**（可选）— 默认与输入文件同目录
6. **点击「开始校验」** — 等待校验完成，结果会实时显示在表格中
7. **查看报告** — 校验完成后自动生成 Excel 报告

---

## 界面说明

### 主界面

```
┌───────────────────────────────────────────────┐
│  翻译校验工具                        [⚙ 设置] │
├───────────────────────────────────────────────┤
│  Excel 文件:  [文件路径]            [选择文件] │
│  校验模板:    [▼ 综合翻译质量评估]             │
│  输出目录:    [目录路径]            [选择目录] │
├───────────────────────────────────────────────┤
│  [▶ 开始校验]  [⏸ 暂停]  [⏹ 停止]            │
│  ████████████████████░░░░░░░  68%             │
│  已完成 34/50 (68%)                           │
├───────────────────────────────────────────────┤
│  行号 │ 中文原文     │ 英文译文     │ 评分 │ 摘要│
│  2    │ 你好世界     │ Hello World  │  9   │ ... │
│  3    │ 机器学习     │ Machine Le.. │  7   │ ... │
│  4    │ ...          │ ...          │  4   │ ... │
├───────────────────────────────────────────────┤
│  [日志区域]                                    │
│  10:30:15 开始校验...                          │
│  10:30:16 第2行校验完成，评分: 9               │
└───────────────────────────────────────────────┘
```

- **评分颜色**：绿色（8-10 分）、橙色（6-7 分）、红色（1-5 分）
- **双击表格行**：打开详细结果查看器，显示完整的问题列表、修改建议和总结
- **日志区域**：实时显示校验进度、API 调用状态、错误信息、429 限流等待等

### 操作按钮

| 按钮 | 功能 |
|------|------|
| 开始校验 | 启动校验任务，如有未完成的断点任务会提示是否续传 |
| 暂停 / 继续 | 暂停当前任务，不丢失进度；再次点击继续 |
| 停止 | 终止任务并自动导出已完成的部分结果 |

---

## 设置详解

点击主界面右上角「设置」按钮打开设置对话框，包含两个标签页。

### API 配置

| 选项 | 说明 | 默认值 |
|------|------|--------|
| 服务商 | 选择预设服务商或「自定义」 | 自定义 |
| Base URL | API 地址（选择预设服务商会自动填入） | — |
| API Key | 你的 API 密钥 | — |
| 模型名称 | 使用的模型（选择预设服务商会自动填入） | — |
| 请求间隔 | 相邻两次 API 调用的等待秒数，防止触发频率限制 | 1.0 秒 |
| 批量模式 | 开启后一次请求发送多行翻译（见[批量模式](#批量模式)） | 关闭 |
| 批量大小 | 每次请求包含的翻译行数（2-20） | 5 |

**预设服务商参考：**

| 服务商 | Base URL | 默认模型 |
|--------|----------|----------|
| OpenAI | `https://api.openai.com/v1` | gpt-4o |
| DeepSeek | `https://api.deepseek.com/v1` | deepseek-chat |
| 通义千问 | `https://dashscope.aliyuncs.com/compatible-mode/v1` | qwen-plus |
| Moonshot (Kimi) | `https://api.moonshot.cn/v1` | moonshot-v1-8k |
| 智谱 (GLM) | `https://open.bigmodel.cn/api/paas/v4` | glm-4 |

> 也可以填写任何兼容 OpenAI Chat Completions 接口的第三方服务地址。

### 提示词管理

- 左侧列表展示所有可用模板（内置 + 自定义）
- 点击 `+` 新建自定义模板，点击 `-` 删除自定义模板（内置模板不可删除）
- 右侧编辑区包含 **系统提示词** 和 **用户提示词** 两个文本框
- 用户提示词中使用 `{source_text}` 和 `{target_text}` 作为占位符，运行时自动替换为实际的中英文文本

---

## 输入文件格式

工具读取 `.xlsx` 格式的 Excel 文件，要求如下：

| 列 | 内容 | 说明 |
|----|------|------|
| A 列 | 中文原文 | 必填 |
| B 列 | 英文译文 | 必填 |

- **第 1 行**为表头（自动跳过），数据从**第 2 行**开始读取
- A 列或 B 列为空的行会被自动跳过
- 表头内容不做要求，可以是任意文字

**示例：**

| 中文 | English |
|------|---------|
| 机器学习是人工智能的一个分支。 | Machine learning is a branch of artificial intelligence. |
| 深度学习使用多层神经网络。 | Deep learning uses multi-layer neural networks. |

---

## 输出报告说明

校验完成后自动生成两份 Excel 文件，保存在指定的输出目录中：

### 1. 结果文件

**文件名：** `{原文件名}_checked_{时间戳}.xlsx`（提前停止时为 `_partial_`）

在原始 Excel 的基础上，追加 4 列结果：

| 新增列 | 内容 |
|--------|------|
| 评分 | 1-10 分，5 分及以下单元格标红 |
| 问题 | 发现的翻译问题列表 |
| 修改建议 | 具体修改意见 |
| 总结 | 一句话综合评价 |

### 2. 独立报告

**文件名：** `{原文件名}_report_{时间戳}.xlsx`

独立的评估报告工作簿，包含 7 列：行号、中文原文、英文译文、评分、问题、修改建议、总结。

- 评分 ≤ 5 的行标红高亮
- 评分 6-7 的行标黄
- 首行冻结，方便浏览大量数据

---

## 内置提示词模板

| 模板名称 | 侧重点 |
|----------|--------|
| **翻译准确性检查** | 语义传达、漏译、错译、数字/日期/专有名词 |
| **术语一致性检查** | 专业术语、行业标准译法、专有名词、缩写 |
| **风格与流畅性检查** | 自然程度、中式英语检测、用词地道性、语法 |
| **综合翻译质量评估** | 以上所有维度综合打分 |

**评分标准（所有模板通用）：**

| 分数 | 含义 |
|------|------|
| 9-10 | 翻译准确、流畅、自然，无明显问题 |
| 7-8 | 翻译基本准确，有少量小问题 |
| 5-6 | 翻译存在明显问题，但核心意思基本传达 |
| 3-4 | 翻译有较多错误，影响理解 |
| 1-2 | 翻译严重失误，意思完全偏离 |

---

## 高级功能

### 批量模式

开启后，工具将多行翻译合并到一次 API 请求中，大幅减少 API 调用次数。

- **适用场景**：翻译行数多、单行文本较短时效果显著
- **批量大小**：可在设置中调整（2-20 行），默认 5
- **容错机制**：若模型返回的 JSON 解析失败，自动回退到逐行处理

> 注意：批量模式下，模型需要同时处理多组翻译，评分精度可能略有下降。建议先用少量数据测试效果。

### 断点续传

校验过程中如果被中断（关闭程序、网络异常等），下次打开同一个文件时会提示：

- **是**：从上次中断处继续，已完成的结果直接加载
- **否**：删除旧的断点记录，从头开始
- **取消**：取消本次操作

断点文件保存在 `checkpoints/` 目录下，文件名为 `{Excel文件名}_checkpoint.json`。

### 提前停止并导出

点击「停止」按钮后，工具会：

1. 等待当前正在进行的 API 请求完成
2. 自动将已完成的结果导出为 Excel 报告
3. 文件名中包含 `_partial_` 标识，与完整报告区分

### 429 频率限制自动处理

当 API 返回 429 (Rate Limit) 状态码时：

- 自动读取响应头中的 `Retry-After` 值（最多等待 60 秒）
- 等待后自动重试，最多重试 5 次
- 429 重试不消耗普通重试次数（普通错误最多重试 3 次）
- 所有限流事件会实时显示在日志面板中

### API 请求重试

非 429 类型的请求失败（网络超时、服务器错误等）：

- 最多自动重试 3 次
- 采用指数退避策略（等待 2 秒、4 秒、8 秒）
- 请求超时时间为 60 秒

---

## 常见问题

### Q: 支持哪些 API 服务？

任何兼容 OpenAI Chat Completions 接口的服务均可使用。选择「自定义」服务商后填写对应的 Base URL、API Key 和模型名称即可。

### Q: Excel 文件有多个工作表（Sheet）怎么办？

工具只读取第一个工作表（活跃工作表）的 A、B 列。

### Q: 如何调节校验的严格程度？

可以通过自定义提示词模板来调节。在设置 → 提示词管理中新建模板，修改系统提示词中的评分标准描述。

### Q: 校验速度太慢怎么办？

- 减小「请求间隔」（但注意不要触发 API 频率限制）
- 开启「批量模式」，一次请求校验多行
- 使用响应速度更快的模型

### Q: 提示「API 调用失败」怎么排查？

1. 点击设置中的「测试连接」确认 API 可用
2. 检查 API Key 是否正确、是否有余额
3. 检查 Base URL 是否正确（注意不要多加 `/chat/completions`，工具会自动拼接）
4. 查看日志区域的详细错误信息
5. 如使用代理，确认系统代理环境变量已正确设置

### Q: 配置文件在哪里？

- 运行 exe 时：与 exe 同目录下的 `config.json`
- 从源码运行时：项目根目录下的 `config.json`
- 首次运行自动创建，可手动编辑

---

## 项目结构

```
translation-checker/
├── main.py                  # 入口，加载配置并启动 GUI
├── requirements.txt         # Python 依赖
├── build.spec               # PyInstaller 打包配置
├── config.json              # 运行时生成的配置文件
├── translation_checker.log  # 运行日志
├── checkpoints/             # 断点续传文件目录
├── core/
│   ├── api_client.py        # LLM API 请求封装
│   ├── checker.py           # 校验任务调度
│   ├── excel_handler.py     # Excel 读写与报告生成
│   └── prompts.py           # 内置提示词模板
└── gui/
    ├── app.py               # 主窗口
    ├── settings_dialog.py   # 设置对话框
    └── result_viewer.py     # 详细结果查看器
```

---

## 许可证

MIT License
